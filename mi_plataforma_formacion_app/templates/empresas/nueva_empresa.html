{% extends "base.html" %}
{% block title %}Nueva Empresa{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow border-0">
        <div class="card-header d-flex align-items-center gap-3" style="background: var(--color-sidebar-active); color: var(--color-sidebar-title); border-top-left-radius: 1rem; border-top-right-radius: 1rem; border-bottom: none;">
          <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="max-height:44px; margin-right:16px; background:#fff; border-radius:10px; box-shadow:0 2px 8px #bfa76a22; padding:4px;">
          <h2 class="mb-0 fw-bold" style="color:var(--color-sidebar-title); text-shadow:0 2px 8px #bfa76a22,0 1px 0 #bfa76a22; display:flex; align-items:center; gap:10px;">
            <span class="d-inline-block" style="background:rgba(191,167,106,0.13); border-radius:8px; padding:6px 12px 6px 8px; margin-right:8px; box-shadow:0 2px 8px #bfa76a22;">
              <i class="bi bi-building-add" style="font-size:1.5rem; vertical-align:middle;"></i>
            </span>
            Nueva Empresa
          </h2>
        </div>
        <div class="card-body">
          <form method="post" autocomplete="off">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre <span class="text-danger">*</span></label>
                <input type="text" name="nombre" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">CIF</label>
                <input type="text" name="cif" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">Comercial</label>
                <select name="comercial_id" class="form-select select2">
                  <option value="">---</option>
                  {% for comercial in comerciales %}
                    <option value="{{ comercial.id }}">{{ comercial.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Dirección</label>
                <input type="text" name="direccion" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">Población <small id="poblacion-status" class="badge bg-secondary ms-2 align-top">Comprobando...</small></label>
                <input type="text" name="poblacion" id="input-poblacion" class="form-control" autocomplete="off">
                <datalist id="poblaciones-list"></datalist>
              </div>
              <div class="col-md-3">
                <label class="form-label">Provincia</label>
                <input type="text" name="provincia" id="input-provincia" class="form-control" autocomplete="off">
              </div>
              <div class="col-md-4">
                <label class="form-label">Persona de contacto</label>
                <input type="text" name="contacto" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Teléfono</label>
                <input type="text" name="telefono" class="form-control">
              </div>
            </div>
            <div class="d-flex justify-content-between mt-4">
              <a href="{{ url_for('empresas_bp.gestion_empresas') }}" class="btn btn-outline-secondary fw-semibold" style="border-color:var(--color-btn-gold);color:var(--color-btn-gold);"><i class="bi bi-arrow-left"></i> Cancelar</a>
              <button type="submit" class="btn btn-outline-primary px-4 fw-semibold" style="border-color:var(--color-btn-navy);color:var(--color-btn-navy);"><i class="bi bi-save"></i> Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Ensure jQuery UI autocomplete is available before initializing.
// If it's missing (e.g. browser cached old base.html), load it dynamically then init.
(function(){
  const initAutocomplete = function(){
  if (!$.fn.autocomplete) return;
  // remove datalist to avoid double suggestions when jQuery UI is used
  try{ var _inp = document.getElementById('input-poblacion'); if(_inp && _inp.removeAttribute) _inp.removeAttribute('list'); }catch(e){}
    $('#input-poblacion').autocomplete({
      source: function(request, response) {
        $.getJSON("{{ url_for('empresas_bp.api_poblaciones') }}", { q: request.term }, function(data) {
          response($.map(data, function(item) {
            return { label: item.poblacion + " (" + item.provincia + ")", value: item.poblacion, provincia: item.provincia };
          }));
        });
      },
      minLength: 2,
      select: function(event, ui) {
        $('#input-poblacion').val(ui.item.value);
        $('#input-provincia').val(ui.item.provincia);
        return false;
      }
    })
    .autocomplete("instance")._renderItem = function(ul, item) {
      return $("<li>")
        .append("<div>" + item.label + "</div>")
        .appendTo(ul);
    };
  };

  // If jQuery UI is present, init immediately on DOM ready
  if ($.fn && $.fn.autocomplete) {
    $(initAutocomplete);
    return;
  }

  // Otherwise, dynamically load jQuery UI CSS+JS then init
  const loadScript = function(url, cb){
    const s = document.createElement('script'); s.src = url; s.async = true;
    s.onload = cb; s.onerror = cb; document.head.appendChild(s);
  };
  const loadCss = function(url){
    const l = document.createElement('link'); l.rel = 'stylesheet'; l.href = url; document.head.appendChild(l);
  };

  // CDN URLs (same as base.html fallback)
  const uiCss = 'https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css';
  const uiJs  = 'https://code.jquery.com/ui/1.13.2/jquery-ui.min.js';

  // Load CSS then JS
  try{
    loadCss(uiCss);
    loadScript(uiJs, function(){
      // small delay to ensure widget registered
      setTimeout(function(){ $(initAutocomplete); }, 20);
    });
  }catch(e){
    // final fallback: init anyway (no-op if missing)
    $(initAutocomplete);
  }
})();
</script>
<script>
// Runtime check: update small badge so developer can see status quickly
document.addEventListener('DOMContentLoaded', function(){
  var badge = document.getElementById('poblacion-status');
  function setBadge(text, cls){ if(!badge) return; badge.textContent = text; badge.className = 'badge ' + cls + ' ms-2 align-top'; }
  // Check for jquery ui
  if(!(window.$ && $.fn && $.fn.autocomplete)){
    setBadge('No UI', 'bg-danger');
  } else {
    setBadge('UI ok', 'bg-success');
  }
  // Ping API
  fetch("{{ url_for('empresas_bp.api_poblaciones') }}?q=Val", { cache:'no-store' })
    .then(r => r.json())
    .then(data => {
      if(!data || (Array.isArray(data) && data.length === 0)) setBadge('API ok (sin matches)', 'bg-warning');
      else setBadge('API ok', 'bg-success');
    }).catch(function(){ setBadge('API error', 'bg-danger'); });
});
</script>
  <script>
  // Datalist fallback for poblacion (works without jQuery UI)
  document.addEventListener('DOMContentLoaded', function(){
    const input = document.getElementById('input-poblacion');
    const provinciaInput = document.getElementById('input-provincia');
    const list = document.getElementById('poblaciones-list');
    if(!input || !list) return;
    // Only enable datalist fallback if jQuery UI autocomplete is NOT present
    if(window.$ && $.fn && $.fn.autocomplete){
      try{ if(input.removeAttribute) input.removeAttribute('list'); }catch(e){}
      return;
    }
    input.setAttribute('list', 'poblaciones-list');
    let mapProv = Object.create(null);
    let timer = null;
    const apiUrl = "{{ url_for('empresas_bp.api_poblaciones') }}";
    function fetchSuggestions(q){
      if(!q || q.length < 2) return;
      fetch(apiUrl + '?q=' + encodeURIComponent(q), { cache:'no-store' })
        .then(r => r.json())
        .then(data => {
          mapProv = Object.create(null);
          list.innerHTML = '';
          if(!Array.isArray(data)) return;
          data.forEach(function(it){
            const opt = document.createElement('option');
            opt.value = it.poblacion;
            list.appendChild(opt);
            mapProv[it.poblacion] = it.provincia;
          });
        }).catch(()=>{});
    }
    input.addEventListener('input', function(e){
      const v = (this.value || '').trim();
      if(timer) clearTimeout(timer);
      timer = setTimeout(function(){ fetchSuggestions(v); }, 220);
      // if exact match already present in map, fill provincia immediately
      if(mapProv[v]) provinciaInput.value = mapProv[v];
    });
    // On change/blur, if user selected a value that exists, set provincia
    input.addEventListener('change', function(){
      const v = (this.value || '').trim();
      if(mapProv[v]) provinciaInput.value = mapProv[v];
    });
  });
  </script>
{% endblock %}

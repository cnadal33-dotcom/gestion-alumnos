{% extends "base.html" %}
{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    .dashboard-title {
      font-size: 2.1rem;
      font-weight: 600;
      color: #213046;
      margin-bottom: 1.4rem;
      letter-spacing: .5px;
    }
    .dashboard-metrics {
      display: flex;
      gap: 18px;
      margin-bottom: 22px;
      flex-wrap: wrap;
    }
    .dashboard-metric {
      flex: 1;
      min-width: 220px;
      background: #fff;
      border-radius: 18px;
      padding: 22px 22px 16px 22px;
      box-shadow: 0 1px 6px #2130460d;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      transition: box-shadow .18s;
      border: 1px solid #ececec;
    }
    .dashboard-metric:hover {
      box-shadow: 0 4px 16px #21304616;
      border-color: #dbeafe;
    }
    .dashboard-metric .icon {
      font-size: 1.7rem;
      color: #005bbb;
      margin-bottom: 0.2em;
    }
    .dashboard-metric h2 {
      font-size: 1.9rem;
      margin: 0 0 2px 0;
      font-weight: 700;
      color: #0b2240;
    }
    .dashboard-metric p {
      font-size: 1.06rem;
      color: #556;
      margin: 0 0 10px 0;
      font-weight: 500;
    }
    .dashboard-metric a.btn {
      padding: 3px 17px;
      font-size: .97em;
      background: #f4f6fa;
      color: #005bbb;
      border: 1px solid #e1e8f4;
      border-radius: 7px;
      margin-top: 2px;
      font-weight: 500;
      transition: background .15s, color .15s;
    }
    .dashboard-metric a.btn:hover {
      background: #005bbb;
      color: #fff;
    }

    .filter-bar {
      background: #f8fafd;
      border-radius: 11px;
      box-shadow: 0 1px 6px #2130460a;
      border: 1px solid #ebf0f6;
      padding: 14px 18px 8px 18px;
      margin-bottom: 1.6rem;
    }
    .filtered-totals {
      font-size: 1.12em;
      color: #005bbb;
      font-weight: 500;
      background: #e9f1ff;
      border-radius: 0.5rem;
      padding: 10px 18px 7px 18px;
      margin-bottom: 20px;
      margin-top: -2px;
      border-left: 5px solid #005bbb;
      box-shadow: 0 1px 3px #005bbb08;
    }
    .buscador-dashboard input {
      border-radius: 10px;
      border: 1px solid #dbeafe;
      box-shadow: 0 1px 5px #005bbb08;
      font-size: 1.1em;
      padding: 9px 13px;
      margin-bottom: 12px;
    }
    .dashboard-block {
      background: #fff;
      border-radius: 13px;
      box-shadow: 0 1px 6px #2130460b;
      padding: 22px;
      margin-bottom: 26px;
      border: 1px solid #ececec;
    }
    .dashboard-block h4 {
      font-size: 1.18rem;
      font-weight: 700;
      color: #0b2240;
      margin-bottom: 18px;
    }
    /* Responsive */
    @media (max-width: 900px) {
      .dashboard-metrics { flex-direction: column; gap: 14px; }
      .dashboard-metric { min-width: 180px; }
    }
  </style>
{% endblock %}
{% block content %}
<div class="container py-4">
  <h1 class="dashboard-title">Panel Administrativo</h1>
  <!-- FILTROS SUPERIORES -->
  <form class="filter-bar row gx-3 mb-3 align-items-center" method="get" action="{{ url_for('admin_bp.dashboard') }}">
    <div class="col-md-3">
      <label for="anio" class="form-label">Año</label>
      <select name="anio" id="anio" class="form-select">
        <option value="">Todos</option>
        {% for a in lista_anios %}
        <option value="{{ a }}" {% if a==anio %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label for="empresa" class="form-label">Empresa</label>
      <select name="empresa_id" id="empresa" class="form-select">
        <option value="">Todas</option>
        {% for emp in empresas_all %}
        <option value="{{ emp.id }}" {% if emp.id==empresa_id %}selected{% endif %}>{{ emp.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label>&nbsp;</label>
      <button class="btn btn-primary w-100" type="submit">
        <i class="bi bi-funnel"></i> Filtrar
      </button>
    </div>
    <div class="col-md-3 text-end">
      <a href="{{ url_for('admin_bp.dashboard') }}" class="btn btn-outline-secondary mt-2 mt-md-0">Quitar Filtros</a>
    </div>
  </form>

  {% if anio or empresa_id %}
    <div class="filtered-totals">
      <span>
        Totales <span class="text-primary">filtrados</span>:
        <b>{{ total_alumnos_filtrado }}</b> alumno(s)
        &nbsp;|&nbsp; <b>{{ total_formaciones_filtrado }}</b> formación(es)
        &nbsp;|&nbsp; <b>{{ total_empresas_filtrado }}</b> empresa(s)
      </span>
      <br>
      {% if anio %} <span>Año: <b>{{ anio }}</b></span> {% endif %}
      {% if empresa_id %}
        {% set emp = empresas_all | selectattr('id', 'equalto', empresa_id|int) | list | first %}
        <span>Empresa: <b>{{ emp.nombre if emp else '' }}</b></span>
      {% endif %}
    </div>
  {% endif %}

  <!-- Métricas resumen -->
  <div class="dashboard-metrics">
    <div class="dashboard-metric">
      <span class="icon"><i class="bi bi-people-fill"></i></span>
      <h2>{{ total_alumnos }}</h2>
      <p>Alumnos <span class="text-muted small">(global)</span></p>
      <a href="{{ url_for('alumnos_bp.lista_alumnos') }}" class="btn">Ver alumnos</a>
    </div>
    <div class="dashboard-metric">
      <span class="icon"><i class="bi bi-building"></i></span>
      <h2>{{ total_empresas }}</h2>
      <p>Empresas <span class="text-muted small">(global)</span></p>
      <a href="{{ url_for('empresas_bp.gestion_empresas') }}" class="btn">Ver empresas</a>
    </div>
    <div class="dashboard-metric">
      <span class="icon"><i class="bi bi-journal-text"></i></span>
      <h2>{{ total_formaciones }}</h2>
      <p>Formaciones <span class="text-muted small">(global)</span></p>
      <a href="{{ url_for('formaciones_bp.gestion_formaciones') }}" class="btn">Ver formaciones</a>
    </div>
  </div>

  <!-- BUSCADOR GLOBAL -->
  <form action="{{ url_for('admin_bp.buscar_global') }}" method="get" class="mb-3 buscador-dashboard">
    <input type="text" name="q" placeholder="Buscar alumno, empresa, formación..." class="form-control" autofocus>
  </form>

  <div class="row">
    <div class="col-lg-7">
      <div class="dashboard-block">
        <h4>Próximas formaciones en los próximos 90 días:</h4>
        {% if formaciones_caducan %}
          <ul>
          {% for f in formaciones_caducan %}
            <li>
              {{ f.tipo_curso.nombre }} - {{ f.fecha1.strftime("%d/%m/%Y") if f.fecha1 else "-" }}
              ({{ f.empresa.nombre if f.empresa else "Sin empresa" }})
            </li>
          {% endfor %}
          </ul>
        {% else %}
          <p class="text-success">No hay formaciones próximas a caducar.</p>
        {% endif %}
      </div>
    </div>
    <div class="col-lg-5">
      <div class="dashboard-block">
        <h4>Resumen formaciones por año{% if empresa_id and emp %} de <b>{{ emp.nombre }}</b>{% endif %}</h4>
        <canvas id="graficoFormaciones"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var ctx = document.getElementById('graficoFormaciones');
  if (ctx) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{ chart_labels|tojson }},
        datasets: [{
          label: "Formaciones",
          data: {{ chart_data|tojson }},
          borderWidth: 2,
          backgroundColor: '#005bbb33'
        }]
      },
      options: {
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
});
</script>
{% endblock %}
